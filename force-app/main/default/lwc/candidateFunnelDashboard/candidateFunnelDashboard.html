<template>
    <lightning-card title="Candidate Pipeline Funnel" icon-name="standard:opportunity">
        <div slot="actions">
            <lightning-button 
                label={toggleButtonLabel}
                icon-name={toggleButtonIcon}
                onclick={handleToggleView}
                variant="neutral"
                class="slds-m-right_small">
            </lightning-button>
            <lightning-badge label={totalCandidates} class="slds-badge_inverse"></lightning-badge>
        </div>

        <template if:true={isLoading}>
            <div class="slds-p-around_large slds-align_absolute-center">
                <lightning-spinner alternative-text="Loading..." size="medium"></lightning-spinner>
            </div>
        </template>

        <template if:true={error}>
            <div class="slds-text-color_error slds-p-around_medium">
                {error}
            </div>
        </template>

        <template if:false={isLoading}>
            <!-- Table/List View (Original) -->
            <template if:false={showFunnelView}>
                <!-- Summary Cards -->
                <div class="summary-cards slds-p-horizontal_medium slds-p-bottom_medium">
                <div class="summary-card">
                    <div class="summary-value">{totalCandidates}</div>
                    <div class="summary-label">Candidates in Pipeline</div>
                </div>
                <div class="summary-card highlight-green">
                    <div class="summary-value">{totalScheduledInterviews}</div>
                    <div class="summary-label">Scheduled Interviews</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value">{completedThisMonth}</div>
                    <div class="summary-label">Completed This Month</div>
                </div>
                <div class="summary-card highlight-red">
                    <div class="summary-value">{biggestDropOffRate}%</div>
                    <div class="summary-label">Biggest Drop-off</div>
                    <div class="summary-sublabel">{biggestDropOffStage}</div>
                </div>
            </div>

            <!-- Funnel Visualization -->
            <div class="funnel-container slds-p-horizontal_medium">
                <template for:each={stages} for:item="stage">
                    <div key={stage.value} 
                         class="funnel-row"
                         data-stage={stage.value}
                         onclick={handleStageClick}>
                        
                        <!-- Stage Label -->
                        <div class="stage-label">
                            <span class="stage-name">{stage.label}</span>
                        </div>

                        <!-- Funnel Bar -->
                        <div class="funnel-bar-container">
                            <div class="funnel-bar" style={stage.barStyle}>
                                <span class="funnel-count">{stage.count} completed</span>
                            </div>
                            <template if:true={stage.scheduledCount}>
                                <span class="scheduled-badge">{stage.scheduledCount} scheduled</span>
                            </template>
                        </div>

                        <!-- Metrics -->
                        <div class="stage-metrics">
                            <template if:false={stage.isFirst}>
                                <div class={stage.conversionClass}>
                                    <lightning-icon icon-name="utility:arrowdown" size="xx-small" class="metric-icon"></lightning-icon>
                                    {stage.conversionRate}%
                                </div>
                            </template>
                            <template if:true={stage.isFirst}>
                                <div class="conversion-start">
                                    <lightning-icon icon-name="utility:trending" size="xx-small" class="metric-icon"></lightning-icon>
                                    Start
                                </div>
                            </template>
                        </div>

                        <!-- Drop-off Indicator -->
                        <div class="dropoff-indicator">
                            <template if:false={stage.isFirst}>
                                <template if:true={stage.dropOffCount}>
                                    <span class={stage.dropOffClass}>
                                        -{stage.dropOffCount} ({stage.dropOffRate}%)
                                    </span>
                                </template>
                            </template>
                        </div>
                    </div>

                    <!-- Connector Arrow -->
                    <template if:false={stage.isLast}>
                        <div key={stage.value} class="connector-arrow">
                            <lightning-icon icon-name="utility:chevrondown" size="x-small"></lightning-icon>
                        </div>
                    </template>
                </template>
            </div>

            <!-- Legend -->
            <div class="legend slds-p-around_medium">
                <div class="legend-item">
                    <span class="legend-dot conversion-excellent"></span>
                    <span>â‰¥80% Conversion</span>
                </div>
                <div class="legend-item">
                    <span class="legend-dot conversion-good"></span>
                    <span>60-79% Conversion</span>
                </div>
                <div class="legend-item">
                    <span class="legend-dot conversion-fair"></span>
                    <span>40-59% Conversion</span>
                </div>
                <div class="legend-item">
                    <span class="legend-dot conversion-poor"></span>
                    <span>&lt;40% Conversion</span>
                </div>
            </div>
            </template>
            <!-- End Table View -->

            <!-- Funnel Visualization View (New) -->
            <template if:true={showFunnelView}>
                <div class="area-chart-container slds-p-around_medium">
                    <!-- Header with Inline Stats -->
                    <div class="area-chart-header-with-stats">
                        <div class="chart-title-section">
                            <div class="chart-title">Candidate Pipeline Analytics</div>
                            <div class="inline-stats">
                                <span class="stat-item">{totalCandidates} Total Current in Pipeline</span>
                                <span class="stat-divider">|</span>
                                <span class="stat-item stat-success">{totalScheduledInterviews} Scheduled</span>
                                <span class="stat-divider">|</span>
                                <span class="stat-item">{completedThisMonth} Completed this Month ({currentMonthAbbr})</span>
                                <span class="stat-divider">|</span>
                                <span class="stat-item stat-warning">{biggestDropOffRate}% Max Drop-off</span>
                            </div>
                        </div>
                    </div>

                    <!-- Echarts Container -->
                    <div class="echarts-container"></div>
                    
                    <!-- Conversion Info Panel on Right -->
                    <div class={conversionPanelClass}>
                        <div class="panel-title">Stage Conversion</div>
                        
                        <template for:each={stages} for:item="stage" for:index="index">
                            <template if:false={stage.isFirst}>
                                <div key={stage.value} class="conversion-row">
                                    <div class={stage.conversionClass}>
                                        <lightning-icon icon-name="utility:arrowdown" size="xx-small"></lightning-icon>
                                        {stage.conversionRate}%
                                    </div>
                                    <div class="conversion-detail">
                                        -{stage.dropOffCount} ({stage.dropOffRate}%)
                                    </div>
                                </div>
                            </template>
                        </template>
                    </div>
                </div>
            </template>
            <!-- End Funnel View -->

        </template>
    </lightning-card>
</template>
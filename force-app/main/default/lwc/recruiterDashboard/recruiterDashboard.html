<template>
  <div class="dashboard-container">
    <!-- Branded Header -->
    <div class="branded-header">
      <div class="slds-page-header__row">
        <div class="slds-page-header__col-title">
          <div class="slds-media">
            <div class="slds-media__figure">
              <div class="company-logo">
                <lightning-icon icon-name="standard:lead" alternative-text="Company Logo" size="large" class="logo-icon"></lightning-icon>
              </div>
            </div>
            <div class="slds-media__body">
              <div class="slds-page-header__name">
                <div class="slds-page-header__name-title">
                  <h1>
                    <span class="slds-page-header__title slds-truncate" title="Recruiter Dashboard">Capstone Partners - Recruiter Portal</span>
                  </h1>
                </div>
              </div>
              <!-- Welcome Message - moved below title -->
              <div class="welcome-message">
                <span class="slds-text-heading_small slds-text-color_inverse">{timeBasedGreeting}, {userFirstName}!</span>
              </div>
            </div>
          </div>
        </div>
        <div class="slds-page-header__col-actions">
          <!-- Action Buttons Row -->
          <div class="action-buttons-container">
            <lightning-button-group>
              <lightning-button 
                variant="brand" 
                label="Create Ticket" 
                icon-name="utility:add"
                onclick={openCreateTicketModal}
                class="action-button">
              </lightning-button>
              <lightning-button 
                variant="brand" 
                label="Schedule Call" 
                icon-name="utility:phone_portrait"
                onclick={openScheduleCallModal}
                class="action-button">
              </lightning-button>
              <lightning-button 
                variant="brand" 
                label="Reschedule Calls" 
                icon-name="utility:event"
                onclick={openRescheduleCallsModal}
                class="action-button">
              </lightning-button>
              <lightning-button 
                variant="brand" 
                label="Create New Candidate" 
                icon-name="utility:add_contact"
                onclick={openCreateNewCandidateFlow}
                class="action-button">
              </lightning-button>

            </lightning-button-group>
          </div>
        </div>
      </div>
    </div>

    <!-- Dashboard Content -->
    <div class="slds-grid slds-wrap slds-gutters slds-p-top_large">
      
      <!-- Call Management Lists -->
      <div class="slds-col slds-size_12-of-12 slds-p-bottom_medium">
        <div class="slds-grid slds-wrap slds-gutters">
          
          <!-- Scheduled Calls List -->
          <div class="slds-col slds-size_6-of-12">
            <lightning-card title="📅 Scheduled Calls" icon-name="utility:clock">
              <div slot="actions">
                <lightning-button-menu 
                  alternative-text="Show menu" 
                  icon-size="x-small" 
                  menu-alignment="right">
                  <lightning-menu-item value="refresh" label="Refresh" onclick={loadScheduledCalls}></lightning-menu-item>
                  <lightning-menu-item value="viewall" label="View All" onclick={openScheduledCallsModal}></lightning-menu-item>
                </lightning-button-menu>
              </div>
              <div class="slds-p-horizontal_medium">
                <template if:true={scheduledCallsList}>
                  <template if:true={scheduledCallsList.length}>
                    <div class="call-list-container">
                      <template for:each={scheduledCallsList} for:item="call" for:index="index">
                        <div key={call.id} class="call-list-item slds-p-vertical_x-small slds-border_bottom">
                          <div class="slds-grid slds-grid_align-spread slds-grid_vertical-align-center">
                            <div class="slds-col slds-grow">
                              <div class="call-candidate-name">{call.candidateName}</div>
                              <div class="call-details">
                                <span class="call-date">{call.formattedDate}</span>
                                <span class="call-separator"> • </span>
                                <span class="call-time">{call.formattedTime}</span>
                              </div>
                            </div>
                            <div class="slds-col slds-no-flex">
                              <lightning-button 
                                variant="brand-outline" 
                                label="Complete" 
                                size="small"
                                data-call-id={call.id}
                                onclick={handleCompleteCall}>
                              </lightning-button>
                            </div>
                          </div>
                        </div>
                      </template>
                    </div>
                  </template>
                  <template if:false={scheduledCallsList.length}>
                    <div class="slds-text-align_center slds-p-vertical_large">
                      <lightning-icon icon-name="utility:check" size="large" class="slds-text-color_success"></lightning-icon>
                      <p class="slds-text-heading_small slds-p-top_small">No scheduled calls</p>
                      <p class="slds-text-body_small slds-text-color_weak">All caught up!</p>
                    </div>
                  </template>
                </template>
              </div>
            </lightning-card>
          </div>

          <!-- Past Due Calls List -->
          <div class="slds-col slds-size_6-of-12">
            <lightning-card title="⚠️ Past Due Calls" icon-name="utility:warning">
              <div slot="actions">
                <lightning-button-menu 
                  alternative-text="Show menu" 
                  icon-size="x-small" 
                  menu-alignment="right">
                  <lightning-menu-item value="refresh" label="Refresh" onclick={loadPastDueCalls}></lightning-menu-item>
                  <lightning-menu-item value="viewall" label="View All" onclick={openPastDueCallsModal}></lightning-menu-item>
                </lightning-button-menu>
              </div>
              <div class="slds-p-horizontal_medium">
                <template if:true={pastDueCallsList}>
                  <template if:true={pastDueCallsList.length}>
                    <div class="call-list-container">
                      <template for:each={pastDueCallsList} for:item="call" for:index="index">
                        <div key={call.id} class="call-list-item slds-p-vertical_x-small slds-border_bottom past-due">
                          <div class="slds-grid slds-grid_align-spread slds-grid_vertical-align-center">
                            <div class="slds-col slds-grow">
                              <div class="call-candidate-name">{call.candidateName}</div>
                              <div class="call-details">
                                <span class="call-date overdue">{call.formattedDate}</span>
                                <span class="call-separator"> • </span>
                                <span class="call-time">{call.formattedTime}</span>
                                <span class="call-separator"> • </span>
                                <span class="days-overdue">Past due</span>
                              </div>
                            </div>
                            <div class="slds-col slds-no-flex">
                              <lightning-button 
                                variant="destructive-text" 
                                label="Complete" 
                                size="small"
                                data-call-id={call.id}
                                onclick={handleCompleteCall}>
                              </lightning-button>
                            </div>
                          </div>
                        </div>
                      </template>
                    </div>
                  </template>
                  <template if:false={pastDueCallsList.length}>
                    <div class="slds-text-align_center slds-p-vertical_large">
                      <lightning-icon icon-name="utility:success" size="large" class="slds-text-color_success"></lightning-icon>
                      <p class="slds-text-heading_small slds-p-top_small">No past due calls</p>
                      <p class="slds-text-body_small slds-text-color_weak">Great work staying on top of your calls!</p>
                    </div>
                  </template>
                </template>
              </div>
            </lightning-card>
          </div>
        </div>
      </div>

      <!-- Candidate Statistics -->
      <div class="slds-col slds-size_6-of-12">
        <lightning-card title="👥 Candidate Pipeline" icon-name="utility:people">
          <div class="slds-p-around_medium">
            
            <!-- Active/In Progress Candidate Analytics Pie Chart -->
            <template if:true={pieChartData}>
              <div class="slds-grid slds-wrap slds-m-bottom_medium">
                <div class="slds-col slds-size_12">
                  <div class="slds-text-align_center">
                    <h3 class="slds-text-heading_small slds-m-bottom_small">📊 Active/In Progress Candidates by Sales Manager</h3>
                    <div class="slds-grid slds-grid_align-center">
                      
                      <!-- Pie Chart -->
                      <div class="slds-col slds-size_6-of-12">
                        <div class="pie-chart-container">
                          <svg width="220" height="220" viewBox="0 0 220 220" class="pie-chart">
                            <template for:each={pieChartData} for:item="segment" for:index="index">
                              <path key={segment.label} 
                                    d={segment.pathData} 
                                    fill={segment.color}
                                    stroke="#fff"
                                    stroke-width="2"
                                    class="pie-segment">
                              </path>
                            </template>
                          </svg>
                        </div>
                      </div>
                      
                      <!-- Legend -->
                      <div class="slds-col slds-size_6-of-12">
                        <div class="chart-legend">
                          <template for:each={pieChartData} for:item="item">
                            <div key={item.label} class="legend-item slds-m-bottom_x-small">
                              <div class="slds-grid slds-grid_vertical-align-center">
                                <div class="legend-color-box" data-color={item.color}></div>
                                <div class="legend-text slds-p-left_small">
                                  <div class="legend-label slds-text-body_small">{item.label}</div>
                                  <div class="legend-value slds-text-body_small slds-text-color_weak">{item.value} ({item.percentage}%)</div>
                                </div>
                              </div>
                            </div>
                          </template>
                        </div>
                      </div>
                      
                    </div>
                  </div>
                </div>
              </div>
            </template>
            
            <div class="slds-grid slds-wrap">
              <div class="slds-col slds-size_12 slds-p-bottom_small">
                <div class="slds-text-align_center clickable-metric" onclick={showActiveCandidates} title="Click to view active candidates">
                  <div class="slds-text-heading_large slds-text-color_success">{candidateStats.active}</div>
                  <div class="slds-text-body_regular slds-m-top_x-small">Active/In Process</div>
                </div>
              </div>
            </div>
          </div>
        </lightning-card>
      </div>

      <!-- Interview Statistics -->
      <div class="slds-col slds-size_6-of-12">
        <lightning-card title="� Interview Leaderboard 🚨" icon-name="utility:event">
          <div class="slds-p-around_medium">
            <template if:true={interviewerLeaderboard}>
              
              <!-- Leaderboard Header Stats -->
              <div class="slds-grid slds-gutters slds-m-bottom_medium">
                <div class="slds-col slds-size_6-of-12">
                  <div class="slds-text-align_center slds-p-around_small" style="background: linear-gradient(135deg, #0176d3, #06a59a); color: white; border-radius: 8px;">
                    <div class="slds-text-heading_large">{totalInterviews}</div>
                    <div class="slds-text-body_small">Total Interviews</div>
                  </div>
                </div>
                <div class="slds-col slds-size_6-of-12">
                  <div class="slds-text-align_center slds-p-around_small" style="background: linear-gradient(135deg, #e74c3c, #f39c12); color: white; border-radius: 8px;">
                    <div class="slds-text-heading_large">{activeInterviewers}</div>
                    <div class="slds-text-body_small">Active Interviewers</div>
                  </div>
                </div>
              </div>

              <!-- Interview Type Breakdown -->
              <div class="slds-grid slds-wrap slds-gutters slds-m-bottom_medium">
                <div class="slds-col slds-size_2-of-12 slds-text-align_center">
                  <div class="slds-p-around_small" style="background: #0176d3; color: white; border-radius: 8px;">
                    <div class="slds-text-heading_medium">{interviewStats.attraction}</div>
                    <div class="slds-text-body_small">Attraction</div>
                  </div>
                </div>
                <div class="slds-col slds-size_2-of-12 slds-text-align_center">
                  <div class="slds-p-around_small" style="background: #06a59a; color: white; border-radius: 8px;">
                    <div class="slds-text-heading_medium">{interviewStats.si1}</div>
                    <div class="slds-text-body_small">SI 1</div>
                  </div>
                </div>
                <div class="slds-col slds-size_2-of-12 slds-text-align_center">
                  <div class="slds-p-around_small" style="background: #e74c3c; color: white; border-radius: 8px;">
                    <div class="slds-text-heading_medium">{interviewStats.si2}</div>
                    <div class="slds-text-body_small">SI 2</div>
                  </div>
                </div>
                <div class="slds-col slds-size_2-of-12 slds-text-align_center">
                  <div class="slds-p-around_small" style="background: #f39c12; color: white; border-radius: 8px;">
                    <div class="slds-text-heading_medium">{interviewStats.si3}</div>
                    <div class="slds-text-body_small">SI 3</div>
                  </div>
                </div>
                <div class="slds-col slds-size_2-of-12 slds-text-align_center">
                  <div class="slds-p-around_small" style="background: #9b59b6; color: white; border-radius: 8px;">
                    <div class="slds-text-heading_medium">{interviewStats.career}</div>
                    <div class="slds-text-body_small">Career</div>
                  </div>
                </div>
                <div class="slds-col slds-size_2-of-12 slds-text-align_center">
                  <div class="slds-p-around_small" style="background: #34495e; color: white; border-radius: 8px;">
                    <div class="slds-text-heading_medium">{interviewStats.thisWeek}</div>
                    <div class="slds-text-body_small">This Week</div>
                  </div>
                </div>
              </div>

              <!-- Leaderboard List -->
              <div class="slds-grid slds-wrap slds-m-bottom_medium">
                <div class="slds-col slds-size_6-of-12 slds-p-bottom_small">
                  <div class="slds-text-align_center interview-type-stat" data-type="attraction">
                    
                    <!-- Mini Pie Chart for Attraction - Table Layout -->
                    <template if:true={attractionMiniChart}>
                      <template if:true={attractionMiniChart.length}>
                        <table style="width: 100%; margin-bottom: 0.5rem;">
                          <tr>
                            <!-- Legend (Left Side) -->
                            <td style="width: 70%; vertical-align: top; padding-right: 1rem;">
                              <template for:each={attractionMiniChart} for:item="segment">
                                <div key={segment.interviewer} style="display: flex; justify-content: space-between; align-items: center; padding: 0.25rem 0; border-bottom: 1px solid #f3f3f3; font-size: 0.75rem;">
                                  <div style="display: flex; align-items: center;">
                                    <div class={segment.colorClass} style="width: 10px; height: 10px; border-radius: 2px; margin-right: 0.5rem;"></div>
                                    <span style="font-weight: 500;" title={segment.interviewer}>{segment.interviewer}</span>
                                  </div>
                                  <span style="font-weight: 700; color: #0176d3;">{segment.count}</span>
                                </div>
                              </template>
                            </td>
                            
                            <!-- Pie Chart (Right Side) -->
                            <td style="width: 30%; text-align: center; vertical-align: top; position: relative;">
                              <div style="position: relative; display: inline-block;">
                                <svg style="width: 100px; height: 100px; transform: rotate(-90deg);" viewBox="0 0 100 100">
                                  <template for:each={attractionMiniChart} for:item="segment">
                                    <path key={segment.interviewer} 
                                          d={segment.pathData} 
                                          fill={segment.color}
                                          stroke="#ffffff"
                                          stroke-width="1"
                                          title={segment.interviewer}>
                                    </path>
                                  </template>
                                </svg>
                                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 1rem; font-weight: 700; color: #3e3e3c;">{attractionMiniTotal}</div>
                              </div>
                            </td>
                          </tr>
                        </table>
                      </template>
                    </template>
                    
                    <div class="slds-text-heading_medium interview-stat-attraction">{interviewStats.attraction}</div>
                    <div class="slds-text-body_small">Attraction</div>
                  </div>
                </div>
                <div class="slds-col slds-size_6-of-12 slds-p-bottom_small">
                  <div class="slds-text-align_center interview-type-stat" data-type="si1">
                    
                    <!-- Mini Pie Chart for SI1 -->
                    <template if:true={si1MiniChart}>
                      <template if:true={si1MiniChart.length}>
                        <div class="slds-grid slds-wrap slds-gutters_x-small slds-m-bottom_x-small" style="align-items: flex-start;">
                          <!-- Legend for SI1 (Left Side) -->
                          <div class="slds-col slds-size_8-of-12" style="min-width: 200px;">
                            <div style="font-size: 0.75rem; color: #3e3e3c;">
                              <template for:each={si1MiniChart} for:item="segment">
                                <div key={segment.interviewer} class="slds-grid slds-grid_align-spread slds-p-vertical_xx-small" style="border-bottom: 1px solid #f3f3f3;">
                                  <div class="slds-col slds-grid slds-grid_vertical-align-center">
                                    <div class={segment.colorClass} style="width: 10px; height: 10px; border-radius: 2px; margin-right: 0.5rem; display: inline-block;"></div>
                                    <span style="font-weight: 500; font-size: 0.75rem;" title={segment.interviewer}>{segment.interviewer}</span>
                                  </div>
                                  <div class="slds-col slds-shrink-none" style="font-weight: 700; color: #0176d3; font-size: 0.75rem;">{segment.count}</div>
                                </div>
                              </template>
                            </div>
                          </div>
                          
                          <!-- Pie Chart (Right Side) -->
                          <div class="slds-col slds-size_4-of-12" style="text-align: center; position: relative;">
                            <svg style="width: 100px; height: 100px; transform: rotate(-90deg);" viewBox="0 0 100 100">
                              <template for:each={si1MiniChart} for:item="segment">
                                <path key={segment.interviewer} 
                                      d={segment.pathData} 
                                      fill={segment.color}
                                      stroke="#ffffff"
                                      stroke-width="1"
                                      title={segment.interviewer}>
                                </path>
                              </template>
                            </svg>
                            <div style="position: absolute; top: 50px; left: 50%; transform: translate(-50%, -50%); font-size: 1rem; font-weight: 700; color: #3e3e3c; pointer-events: none;">{si1MiniTotal}</div>
                          </div>
                        </div>
                      </template>
                    </template>
                    
                    <div class="slds-text-heading_medium interview-stat-si1">{interviewStats.si1}</div>
                    <div class="slds-text-body_small">SI 1</div>
                  </div>
                </div>
                <div class="slds-col slds-size_4-of-12 slds-p-bottom_small">
                  <div class="slds-text-align_center interview-type-stat" data-type="si2">
                    
                    <!-- Mini Pie Chart for SI2 -->
                    <template if:true={si2MiniChart}>
                      <template if:true={si2MiniChart.length}>
                        <div class="mini-pie-container slds-m-bottom_x-small">
                          <!-- Legend for SI2 (Left Side) -->
                          <div class="mini-pie-legend">
                            <template for:each={si2MiniChart} for:item="segment">
                              <div key={segment.interviewer} class="mini-pie-legend-item">
                                <div class={segment.colorClass}></div>
                                <div class="mini-pie-legend-label" title={segment.interviewer}>{segment.interviewer}</div>
                                <div class="mini-pie-legend-count">{segment.count}</div>
                              </div>
                            </template>
                          </div>
                          
                          <!-- Pie Chart (Right Side) -->
                          <div class="mini-pie-chart-section">
                            <svg class="mini-pie-chart" viewBox="0 0 100 100" width="100" height="100">
                              <template for:each={si2MiniChart} for:item="segment">
                                <path key={segment.interviewer} 
                                      d={segment.pathData} 
                                      fill={segment.color}
                                      title={segment.interviewer}>
                                </path>
                              </template>
                            </svg>
                            <div class="mini-pie-total">{si2MiniTotal}</div>
                          </div>
                        </div>
                      </template>
                    </template>
                    
                    <div class="slds-text-heading_medium interview-stat-si2">{interviewStats.si2}</div>
                    <div class="slds-text-body_small">SI 2</div>
                  </div>
                </div>
                <div class="slds-col slds-size_4-of-12 slds-p-bottom_small">
                  <div class="slds-text-align_center interview-type-stat" data-type="si3">
                    
                    <!-- Mini Pie Chart for SI3 -->
                    <template if:true={si3MiniChart}>
                      <template if:true={si3MiniChart.length}>
                        <div class="mini-pie-container slds-m-bottom_x-small">
                          <!-- Legend for SI3 (Left Side) -->
                          <div class="mini-pie-legend">
                            <template for:each={si3MiniChart} for:item="segment">
                              <div key={segment.interviewer} class="mini-pie-legend-item">
                                <div class={segment.colorClass}></div>
                                <div class="mini-pie-legend-label" title={segment.interviewer}>{segment.interviewer}</div>
                                <div class="mini-pie-legend-count">{segment.count}</div>
                              </div>
                            </template>
                          </div>
                          
                          <!-- Pie Chart (Right Side) -->
                          <div class="mini-pie-chart-section">
                            <svg class="mini-pie-chart" viewBox="0 0 100 100" width="100" height="100">
                              <template for:each={si3MiniChart} for:item="segment">
                                <path key={segment.interviewer} 
                                      d={segment.pathData} 
                                      fill={segment.color}
                                      title={segment.interviewer}>
                                </path>
                              </template>
                            </svg>
                            <div class="mini-pie-total">{si3MiniTotal}</div>
                          </div>
                        </div>
                      </template>
                    </template>
                    
                    <div class="slds-text-heading_medium interview-stat-si3">{interviewStats.si3}</div>
                    <div class="slds-text-body_small">SI 3</div>
                  </div>
                </div>
                <div class="slds-col slds-size_4-of-12 slds-p-bottom_small">
                  <div class="slds-text-align_center interview-type-stat" data-type="career">
                    
                    <!-- Mini Pie Chart for Career -->
                    <template if:true={careerMiniChart}>
                      <template if:true={careerMiniChart.length}>
                        <div class="mini-pie-container slds-m-bottom_x-small">
                          <!-- Legend for Career (Left Side) -->
                          <div class="mini-pie-legend">
                            <template for:each={careerMiniChart} for:item="segment">
                              <div key={segment.interviewer} class="mini-pie-legend-item">
                                <div class={segment.colorClass}></div>
                                <div class="mini-pie-legend-label" title={segment.interviewer}>{segment.interviewer}</div>
                                <div class="mini-pie-legend-count">{segment.count}</div>
                              </div>
                            </template>
                          </div>
                          
                          <!-- Pie Chart (Right Side) -->
                          <div class="mini-pie-chart-section">
                            <svg class="mini-pie-chart" viewBox="0 0 100 100" width="100" height="100">
                              <template for:each={careerMiniChart} for:item="segment">
                                <path key={segment.interviewer} 
                                      d={segment.pathData} 
                                      fill={segment.color}
                                      title={segment.interviewer}>
                                </path>
                              </template>
                            </svg>
                            <div class="mini-pie-total">{careerMiniTotal}</div>
                          </div>
                        </div>
                      </template>
                    </template>
                    
                    <div class="slds-text-heading_medium interview-stat-career">{interviewStats.career}</div>
                    <div class="slds-text-body_small">Career</div>
                  </div>
                </div>
              </div>
              
              <!-- Summary Stats -->
              <div class="slds-grid slds-wrap slds-border_top slds-p-top_small">
                <div class="slds-col slds-size_6-of-12">
                  <div class="slds-text-align_center">
                    <div class="slds-text-heading_medium slds-text-color_success">{interviewStats.thisWeek}</div>
                    <div class="slds-text-body_small">This Week</div>
                  </div>
                </div>
                <div class="slds-col slds-size_6-of-12">
                  <div class="slds-text-align_center">
                    <div class="slds-text-heading_medium slds-text-color_default">{interviewStats.total}</div>
                    <div class="slds-text-body_small">Total Interviews</div>
                  </div>
                </div>
              </div>
              
            </template>
          </div>
        </lightning-card>
      </div>

      <!-- Performance Metrics -->
      <div class="slds-col slds-size_12-of-12 slds-p-top_medium">
        <lightning-card title="📈 Recruiting Performance" icon-name="utility:chart">
          <div class="slds-p-around_medium">
            <template if:true={performanceMetrics}>
              
              <!-- Contract Activity Section -->
              <div class="slds-box" style="background-color: #ffffff; border: 1px solid #dddbda; border-left: 4px solid #0176d3; margin-bottom: 1rem;">
                <h4 class="slds-text-heading_small slds-m-bottom_small" style="color: #0176d3;">📊 Contract Activity (October 2025)</h4>
                <div class="slds-grid slds-wrap slds-gutters">
                  <div class="slds-col slds-size_2-of-12">
                    <div class="slds-text-align_center clickable-metric" onclick={handleContractAAddedClick}>
                      <div class="slds-text-heading_medium slds-text-color_success">{performanceMetrics.contractAAdded}</div>
                      <div class="slds-text-body_small">� Contract A Added</div>
                      <div class="slds-text-body_x-small slds-text-color_weak">Click to view</div>
                    </div>
                  </div>
                  <div class="slds-col slds-size_2-of-12">
                    <div class="slds-text-align_center clickable-metric" onclick={handleContractBAddedClick}>
                      <div class="slds-text-heading_medium slds-text-color_success">{performanceMetrics.contractBAdded}</div>
                      <div class="slds-text-body_small">� Contract B Added</div>
                      <div class="slds-text-body_x-small slds-text-color_weak">Click to view</div>
                    </div>
                  </div>
                  <div class="slds-col slds-size_2-of-12">
                    <div class="slds-text-align_center clickable-metric" onclick={handleContractATermsClick}>
                      <div class="slds-text-heading_medium slds-text-color_error">{performanceMetrics.contractATerminations}</div>
                      <div class="slds-text-body_small">❌ Contract A Terms</div>
                      <div class="slds-text-body_x-small slds-text-color_weak">Click to view</div>
                    </div>
                  </div>
                  <div class="slds-col slds-size_2-of-12">
                    <div class="slds-text-align_center clickable-metric" onclick={handleContractBTermsClick}>
                      <div class="slds-text-heading_medium slds-text-color_error">{performanceMetrics.contractBTerminations}</div>
                      <div class="slds-text-body_small">❌ Contract B Terms</div>
                      <div class="slds-text-body_x-small slds-text-color_weak">Click to view</div>
                    </div>
                  </div>
                  <div class="slds-col slds-size_2-of-12">
                    <div class="slds-text-align_center clickable-metric" onclick={handleBtoATransitionsClick}>
                      <div class="slds-text-heading_medium slds-text-color_warning">{performanceMetrics.contractBtoA}</div>
                      <div class="slds-text-body_small">🔄 B to A Moves</div>
                      <div class="slds-text-body_x-small slds-text-color_weak">Click to view</div>
                    </div>
                  </div>
                  <div class="slds-col slds-size_2-of-12">
                    <div class="slds-text-align_center">
                      <div class="slds-text-heading_medium slds-text-color_warning">{performanceMetrics.interviewsScheduled}</div>
                      <div class="slds-text-body_small">📅 Interviews This Week</div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Net Field Force Calculation -->
              <div class="slds-box" style="background-color: #ffffff; border: 1px solid #dddbda; border-left: 4px solid #4bca81; margin-bottom: 1rem;">
                <h4 class="slds-text-heading_small slds-m-bottom_small" style="color: #2e844a;">🏆 Net Field Force Analysis (2025)</h4>
                <div class="slds-grid slds-wrap slds-gutters slds-m-bottom_medium">
                  <div class="slds-col slds-size_12-of-12">
                    <div class="slds-text-align_center">
                      <div class="slds-text-heading_large slds-text-color_success" style="font-weight: 700; font-size: 2.5rem;">{performanceMetrics.netFieldForce}</div>
                      <div class="slds-text-body_regular" style="font-weight: 600; color: #2e844a;">Net Field Force</div>
                      <div class="slds-text-body_small slds-text-color_weak">Jan 1 Start + Additions - Terminations - B to A Moves</div>
                    </div>
                  </div>
                </div>
                
                <!-- Calculation Breakdown -->
                <div class="slds-grid slds-wrap slds-gutters">
                  <div class="slds-col slds-size_3-of-12">
                    <div class="slds-text-align_center">
                      <div class="slds-text-heading_medium slds-text-color_default">{performanceMetrics.contractAJan1}</div>
                      <div class="slds-text-body_small">📅 Contract A (Jan 1)</div>
                    </div>
                  </div>
                  <div class="slds-col slds-size_3-of-12">
                    <div class="slds-text-align_center">
                      <div class="slds-text-heading_medium slds-text-color_success">+{performanceMetrics.totalContractAAdded}</div>
                      <div class="slds-text-body_small">➕ Contract A Added YTD</div>
                    </div>
                  </div>
                  <div class="slds-col slds-size_3-of-12">
                    <div class="slds-text-align_center">
                      <div class="slds-text-heading_medium slds-text-color_error">-{performanceMetrics.totalContractATerms}</div>
                      <div class="slds-text-body_small">➖ Contract A Terms YTD</div>
                    </div>
                  </div>
                  <div class="slds-col slds-size_3-of-12">
                    <div class="slds-text-align_center clickable-metric" onclick={handleNetFieldForceClick}>
                      <div class="slds-text-heading_medium slds-text-color_warning">+{performanceMetrics.netContractBActivity}</div>
                      <div class="slds-text-body_small">� Net Contract B Activity</div>
                      <div class="slds-text-body_x-small slds-text-color_weak">Click for details</div>
                    </div>
                  </div>
                </div>
              </div>
            </template>
          </div>
        </lightning-card>
      </div>

      <!-- Recent Activity -->
      <div class="slds-col slds-size_12-of-12 slds-p-top_medium">
        <lightning-card title="🔄 Recent Activity" icon-name="utility:activity">
          <div class="slds-p-around_medium">
            <template if:true={recentActivity.length}>
              <template for:each={recentActivity} for:item="activity">
                <div key={activity.id} class="slds-border_bottom slds-p-vertical_small">
                  <div class="slds-grid">
                    <div class="slds-col slds-size_8-of-12">
                      <div class="slds-text-body_regular">
                        <strong>{activity.type}</strong> - {activity.description}
                      </div>
                      <div class="slds-text-body_small slds-text-color_weak">
                        {activity.candidateName} • {activity.timeAgo}
                      </div>
                    </div>
                    <div class="slds-col slds-size_4-of-12 slds-text-align_right">
                      <lightning-badge label={activity.status} variant={activity.statusVariant}></lightning-badge>
                    </div>
                  </div>
                </div>
              </template>
            </template>
            <template if:false={recentActivity.length}>
              <div class="slds-text-align_center slds-p-vertical_large">
                <div class="slds-text-body_regular slds-text-color_weak">No recent activity to display</div>
              </div>
            </template>
          </div>
        </lightning-card>
      </div>

      <!-- Static Resource Demo -->
      <!-- Static Resource Demo section removed for cleaner dashboard -->

    </div>
  </div>

  <!-- Create Ticket Modal -->
  <template if:true={showCreateTicketModal}>
    <section role="dialog" tabindex="-1" class="slds-modal slds-fade-in-open slds-modal_large" aria-labelledby="create-ticket-modal-heading">
      <div class="slds-modal__container">
        <header class="slds-modal__header">
          <button class="slds-button slds-button_icon slds-modal__close slds-button_icon-inverse" title="Close" onclick={closeCreateTicketModal}>
            <lightning-icon icon-name="utility:close" alternative-text="close" size="small"></lightning-icon>
          </button>
          <h2 id="create-ticket-modal-heading" class="slds-text-heading_medium slds-hyphenate">Create Support Ticket</h2>
        </header>
        <div class="slds-modal__content slds-p-around_medium" id="create-ticket-modal-content">
          <lightning-layout multiple-rows>
            <lightning-layout-item size="12" class="slds-p-bottom_small">
              <lightning-input 
                label="Subject" 
                value={ticketSubject} 
                onchange={handleTicketSubjectChange}
                required
                class="slds-p-bottom_small">
              </lightning-input>
            </lightning-layout-item>
            
            <lightning-layout-item size="6" class="slds-p-right_small slds-p-bottom_small">
              <lightning-combobox
                label="Priority"
                value={ticketPriority}
                placeholder="Select Priority"
                options={ticketPriorityOptions}
                onchange={handleTicketPriorityChange}>
              </lightning-combobox>
            </lightning-layout-item>
            
            <lightning-layout-item size="6" class="slds-p-left_small slds-p-bottom_small">
              <lightning-combobox
                label="Category"
                value={ticketCategory}
                placeholder="Select Category"
                options={ticketCategoryOptions}
                onchange={handleTicketCategoryChange}>
              </lightning-combobox>
            </lightning-layout-item>
            
            <lightning-layout-item size="12" class="slds-p-bottom_small">
              <lightning-textarea 
                label="Description" 
                value={ticketDescription} 
                onchange={handleTicketDescriptionChange}
                required
                rows="4"
                class="slds-p-bottom_small">
              </lightning-textarea>
            </lightning-layout-item>
            
            <lightning-layout-item size="12" class="slds-p-bottom_small">
              <lightning-input 
                label="Contact Information" 
                value={ticketContact} 
                onchange={handleTicketContactChange}
                class="slds-p-bottom_small">
              </lightning-input>
            </lightning-layout-item>
            
            <lightning-layout-item size="12" class="slds-p-bottom_small">
              <div class="slds-form-element">
                <label class="slds-form-element__label">Attachments</label>
                <div class="slds-form-element__control">
                  <lightning-button 
                    label="Upload Files" 
                    icon-name="utility:attach" 
                    onclick={handleFileUpload}
                    variant="neutral">
                  </lightning-button>
                  <template if:true={ticketAttachments.length}>
                    <div class="slds-p-top_small">
                      <template for:each={ticketAttachments} for:item="attachment">
                        <div key={attachment.id} class="attachment-item slds-p-vertical_x-small">
                          <lightning-icon icon-name="utility:file" size="x-small" class="slds-m-right_x-small"></lightning-icon>
                          {attachment.name}
                        </div>
                      </template>
                    </div>
                  </template>
                </div>
              </div>
            </lightning-layout-item>
          </lightning-layout>
        </div>
        <footer class="slds-modal__footer">
          <lightning-button variant="neutral" label="Cancel" onclick={closeCreateTicketModal}></lightning-button>
          <lightning-button 
            variant="brand" 
            label="Create Ticket" 
            onclick={submitTicket}
            disabled={isTicketSubmitDisabled}
            icon-name="utility:add">
          </lightning-button>
        </footer>
      </div>
    </section>
    <div class="slds-backdrop slds-backdrop_open"></div>
  </template>

  <!-- Reschedule Calls Modal -->
  <template if:true={showRescheduleCallsModal}>
    <section role="dialog" tabindex="-1" class="slds-modal slds-fade-in-open slds-modal_large" aria-labelledby="reschedule-modal-heading">
      <div class="slds-modal__container" style="max-height: 80vh;">
        <header class="slds-modal__header">
          <button class="slds-button slds-button_icon slds-modal__close slds-button_icon-inverse" title="Close" onclick={closeRescheduleCallsModal}>
            <lightning-icon icon-name="utility:close" alternative-text="close" size="small"></lightning-icon>
          </button>
          <h2 id="reschedule-modal-heading" class="slds-text-heading_medium slds-hyphenate">Reschedule Past Due Calls</h2>
        </header>
        <div class="slds-modal__content slds-p-around_medium" id="reschedule-modal-content" style="overflow-y: auto; max-height: 60vh;">
          <!-- Loading State -->
          <template if:true={isLoadingRescheduleCalls}>
            <div class="slds-align_absolute-center slds-p-around_large">
              <lightning-spinner alternative-text="Loading..." size="medium"></lightning-spinner>
            </div>
          </template>
          
          <!-- Main Content -->
          <template if:false={isLoadingRescheduleCalls}>
            <!-- Reschedule Form - MOVED TO TOP FOR VISIBILITY -->
            <template if:true={selectedCallsForReschedule.length}>
              <div class="slds-box slds-theme_info" style="background-color: #e8f4ff; border: 2px solid #0176d3; margin-bottom: 1rem;">
                <div class="slds-text-align_center slds-p-bottom_small">
                  <h3 class="slds-text-heading_medium" style="color: #0176d3;">📅 Reschedule Form - Selected: {selectedRescheduleCalls.length} calls</h3>
                  <p class="slds-text-body_regular">First select calls below, then fill in the new schedule date:</p>
                </div>
                
                <!-- Date/Time Form -->
                <div class="reschedule-form">
                  <lightning-layout multiple-rows>
                    <lightning-layout-item size="12" class="slds-p-bottom_small">
                      <div class="slds-form-element">
                        <label class="slds-form-element__label slds-text-heading_small" for="reschedule-date">
                          📅 New Schedule Date (Required)
                        </label>
                        <div class="slds-form-element__control">
                          <lightning-input 
                            name="rescheduleDate"
                            type="date" 
                            value={newRescheduleDate}
                            onchange={handleNewRescheduleDateChange}
                            min={todaysDate}
                            variant="standard"
                            class="slds-input_large">
                          </lightning-input>
                      </div>
                    </div>
                  </lightning-layout-item>
                  
                  <lightning-layout-item size="12" class="slds-p-vertical_small">
                    <div class="slds-form-element">
                      <label class="slds-form-element__label" for="reschedule-time">
                        🕐 New Time (Optional)
                      </label>
                      <div class="slds-form-element__control">
                        <lightning-input 
                          name="rescheduleTime"
                          type="time" 
                          value={newRescheduleTime}
                          onchange={handleNewRescheduleTimeChange}
                          variant="label-hidden"
                          placeholder="Leave blank for day-only scheduling">
                        </lightning-input>
                      </div>
                    </div>
                  </lightning-layout-item>
                  
                  <lightning-layout-item size="12" class="slds-p-top_small">
                    <div class="slds-form-element">
                      <label class="slds-form-element__label" for="reschedule-notes">
                        📝 Reschedule Notes (Optional)
                      </label>
                      <div class="slds-form-element__control">
                        <lightning-textarea 
                          name="rescheduleNotes"
                          value={rescheduleNotes}
                          onchange={handleRescheduleNotesChange}
                          rows="2"
                          variant="label-hidden"
                          placeholder="Optional notes about the reschedule...">
                        </lightning-textarea>
                      </div>
                    </div>
                  </lightning-layout-item>
                  
                    <!-- Debug Info -->
                    <lightning-layout-item size="12" class="slds-p-top_small">
                      <div class="slds-text-body_small slds-text-color_weak">
                        Debug: Date="{newRescheduleDate}" | Time="{newRescheduleTime}" | Notes="{rescheduleNotes}"
                      </div>
                    </lightning-layout-item>
                  </lightning-layout>
                </div>
              </div>
            </template>
            
            <!-- Calls Table -->
            <template if:true={selectedCallsForReschedule.length}>
              <div class="slds-p-bottom_small">
                <h4 class="slds-text-heading_small">Select Calls to Reschedule:</h4>
              </div>
              
              <lightning-datatable
                data={selectedCallsForReschedule}
                columns={rescheduleCallColumns}
                key-field="id"
                onrowselection={handleRescheduleCallSelection}
                show-row-number-column>
              </lightning-datatable>
              
            </template>
            
            <!-- No Calls Found -->
            <template if:false={selectedCallsForReschedule.length}>
              <div class="slds-align_absolute-center slds-p-around_large">
                <div class="slds-text-align_center">
                  <lightning-icon icon-name="utility:success" size="large" class="slds-m-bottom_small"></lightning-icon>
                  <p class="slds-text-heading_small">No Past Due Calls Found</p>
                  <p class="slds-text-body_regular">All calls are up to date!</p>
                </div>
              </div>
            </template>
          </template>
        </div>
        <footer class="slds-modal__footer">
          <lightning-button variant="neutral" label="Cancel" onclick={closeRescheduleCallsModal}></lightning-button>
          <lightning-button 
            variant="brand" 
            label="Reschedule Selected Calls" 
            onclick={submitReschedule}
            disabled={isRescheduleSubmitDisabled}
            icon-name="utility:event">
          </lightning-button>
          <div class="slds-p-top_x-small">
            <p class="slds-text-body_small slds-text-color_weak">
              Debug: Selected={selectedRescheduleCalls.length} calls | Date="{newRescheduleDate}" | Time="{newRescheduleTime}" | HasCalls={hasSelectedCalls} | ButtonDisabled={isRescheduleSubmitDisabled}
            </p>
          </div>
        </footer>
      </div>
    </section>
    <div class="slds-backdrop slds-backdrop_open"></div>
  </template>

  <!-- Create New Candidate Modal -->
  <template if:true={showCreateCandidateModal}>
    <section role="dialog" tabindex="-1" class="slds-modal slds-fade-in-open slds-modal_medium" aria-labelledby="candidate-modal-heading">
      <div class="slds-modal__container">
        <header class="slds-modal__header">
          <button class="slds-button slds-button_icon slds-modal__close slds-button_icon-inverse" title="Close" onclick={closeCreateCandidateModal}>
            <lightning-icon icon-name="utility:close" alternative-text="close" size="small"></lightning-icon>
          </button>
          <h2 id="candidate-modal-heading" class="slds-text-heading_medium slds-hyphenate">Create New Candidate</h2>
        </header>
        <div class="slds-modal__content slds-p-around_medium" id="candidate-modal-content">
          <!-- Header Information -->
          <div class="slds-box slds-theme_info" style="background-color: #e8f4ff; border: 2px solid #0176d3; margin-bottom: 1rem;">
            <div class="slds-text-align_center">
              <lightning-icon icon-name="utility:add_contact" size="medium" class="slds-m-bottom_small" style="color: #0176d3;"></lightning-icon>
              <h3 class="slds-text-heading_medium" style="color: #0176d3;">👤 New Candidate Registration</h3>
              <p class="slds-text-body_regular">Enter candidate information below. A Contact record will be created automatically.</p>
            </div>
          </div>

          <!-- Contact Information Section -->
          <div class="ultra-compact-form">
            <div class="form-section">
              <div class="section-header">👤 Contact Information</div>
              
              <!-- Full Name -->
              <div class="compact-field">
                <label class="compact-label" for="new-candidate-name">
                  <abbr class="slds-required" title="required">*</abbr>
                  Full Name
                </label>
                <lightning-input
                  id="new-candidate-name"
                  value={newCandidateName}
                  onchange={handleNewCandidateNameChange}
                  placeholder="Enter candidate's full name"
                  required>
                </lightning-input>
              </div>

              <!-- Email and Phone Row -->
              <div class="compact-field">
                <label class="compact-label" for="new-candidate-email">
                  <abbr class="slds-required" title="required">*</abbr>
                  Email Address
                </label>
                <lightning-input
                  id="new-candidate-email"
                  type="email"
                  value={newCandidateEmail}
                  onchange={handleNewCandidateEmailChange}
                  placeholder="candidate@email.com"
                  required>
                </lightning-input>
              </div>

              <div class="compact-field">
                <label class="compact-label" for="new-candidate-phone">
                  📞 Phone Number
                </label>
                <lightning-input
                  id="new-candidate-phone"
                  type="tel"
                  value={newCandidatePhone}
                  onchange={handleNewCandidatePhoneChange}
                  placeholder="(555) 123-4567">
                </lightning-input>
              </div>
            </div>

            <!-- Candidate Details Section -->
            <div class="form-section">
              <div class="section-header">📋 Candidate Details</div>
              
              <!-- Position -->
              <div class="compact-field">
                <label class="compact-label" for="new-candidate-position">
                  Position
                </label>
                <lightning-combobox
                  id="new-candidate-position"
                  value={newCandidatePosition}
                  placeholder="Select position"
                  options={positionOptions}
                  onchange={handleNewCandidatePositionChange}>
                </lightning-combobox>
              </div>

              <!-- Source -->
              <div class="compact-field">
                <label class="compact-label" for="new-candidate-source">
                  🔍 Lead Source
                </label>
                <lightning-combobox
                  id="new-candidate-source"
                  value={newCandidateSource}
                  placeholder="Select source"
                  options={sourceOptions}
                  onchange={handleNewCandidateSourceChange}>
                </lightning-combobox>
              </div>

              <!-- Notes -->
              <div class="compact-field">
                <label class="compact-label" for="new-candidate-notes">
                  📝 Initial Notes
                </label>
                <lightning-textarea 
                  id="new-candidate-notes"
                  value={newCandidateNotes}
                  onchange={handleNewCandidateNotesChange}
                  placeholder="Enter any initial notes about this candidate..."
                  rows="2">
                </lightning-textarea>
              </div>
            </div>
          </div>

          <!-- Success Preview -->
          <template if:true={newCandidateName}>
            <div class="slds-box slds-theme_success" style="background-color: #f0fff4; border: 1px solid #4bca81; margin-top: 1rem;">
              <div class="slds-text-align_center">
                <h4 class="slds-text-heading_small" style="color: #2e844a;">Preview</h4>
                <p class="slds-text-body_regular">
                  <strong>{newCandidateName}</strong>
                  <template if:true={newCandidateEmail}> • {newCandidateEmail}</template>
                  <template if:true={newCandidatePhone}> • {newCandidatePhone}</template>
                </p>
                <template if:true={newCandidatePosition}>
                  <p class="slds-text-body_small">Position: {newCandidatePosition}</p>
                </template>
                <template if:true={newCandidateSource}>
                  <p class="slds-text-body_small">Source: {newCandidateSource}</p>
                </template>
              </div>
            </div>
          </template>

          <!-- Duplicate Contact Warning -->
          <template if:true={duplicateContactFound}>
            <div class="slds-box slds-theme_warning" style="background-color: #fef7e0; border: 1px solid #fe9339; margin-top: 1rem;">
              <div class="slds-text-align_center">
                <lightning-icon icon-name="utility:warning" size="small" style="color: #fe9339;"></lightning-icon>
                <h4 class="slds-text-heading_small" style="color: #fe9339;">Contact Already Exists</h4>
                <p class="slds-text-body_regular">
                  A contact with email <strong>{newCandidateEmail}</strong> already exists.
                </p>
                <p class="slds-text-body_small">
                  Do you want to create a candidate record for the existing contact?
                </p>
              </div>
            </div>
          </template>
        </div>
        <footer class="slds-modal__footer">
          <lightning-button variant="neutral" label="Cancel" onclick={closeCreateCandidateModal}></lightning-button>
          <lightning-button 
            variant="brand" 
            label="Create Candidate" 
            onclick={handleNewCandidateSubmit}
            disabled={isCandidateSubmitDisabled}
            icon-name="utility:add_contact">
          </lightning-button>
        </footer>
      </div>
    </section>
    <div class="slds-backdrop slds-backdrop_open"></div>
  </template>

  <!-- Call Management Modal (Scheduled & Past Due Calls) -->
  <template if:true={showCallManagementModal}>
    <section role="dialog" tabindex="-1" class="slds-modal slds-fade-in-open slds-modal_large" aria-labelledby="calls-modal-heading">
      <div class="slds-modal__container" style="max-height: 85vh;">
        <header class="slds-modal__header">
          <button class="slds-button slds-button_icon slds-modal__close slds-button_icon-inverse" title="Close" onclick={closeCallManagementModal}>
            <lightning-icon icon-name="utility:close" alternative-text="close" size="small"></lightning-icon>
          </button>
          <h2 id="calls-modal-heading" class="slds-text-heading_medium slds-hyphenate">{callModalTitle}</h2>
        </header>
        <div class="slds-modal__content slds-p-around_medium" id="calls-modal-content">
          
          <!-- Loading State -->
          <template if:true={isLoadingCalls}>
            <div class="slds-align_absolute-center slds-p-around_large">
              <lightning-spinner alternative-text="Loading calls..." size="medium"></lightning-spinner>
            </div>
          </template>

          <!-- No Calls State -->
          <template if:false={isLoadingCalls}>
            <template if:false={callsList.length}>
              <div class="slds-text-align_center slds-p-around_large">
                <lightning-icon icon-name="utility:success" size="large" class="slds-m-bottom_medium" style="color: #4bca81;"></lightning-icon>
                <h3 class="slds-text-heading_medium slds-m-bottom_small">All Caught Up! 🎉</h3>
                <p class="slds-text-body_regular">No {callType} calls to display.</p>
              </div>
            </template>

            <!-- Calls List -->
            <template if:true={callsList.length}>
              <!-- Quick Actions Header -->
              <div class="slds-box slds-theme_info" style="background-color: #e8f4ff; border: 2px solid #0176d3; margin-bottom: 1rem;">
                <div class="slds-text-align_center">
                  <h3 class="slds-text-heading_medium" style="color: #0176d3;">📞 Call Management - {callsList.length} Calls</h3>
                  <p class="slds-text-body_regular">Click any call below to quickly complete it</p>
                </div>
              </div>

              <!-- Scrolling Call List -->
              <div class="call-list-container" style="max-height: 50vh; overflow-y: auto;">
                <template for:each={callsList} for:item="call">
                  <div key={call.id} class="call-item" onclick={selectCallForCompletion} data-call-id={call.id}>
                    <lightning-card>
                      <div class="slds-grid slds-gutters slds-p-around_small">
                        <!-- Call Priority Indicator -->
                        <div class="slds-col slds-size_1-of-12 slds-text-align_center">
                          <div class="priority-indicator" data-priority={call.priority}>
                            <lightning-icon icon-name="utility:priority" size="small" 
                              class={call.priorityClass}></lightning-icon>
                          </div>
                        </div>

                        <!-- Call Details -->
                        <div class="slds-col slds-size_7-of-12">
                          <div class="slds-grid">
                            <div class="slds-col slds-size_12-of-12">
                              <h4 class="slds-text-heading_small slds-m-bottom_x-small">
                                <strong>{call.candidateName}</strong>
                              </h4>
                              <p class="slds-text-body_regular slds-m-bottom_x-small">{call.subject}</p>
                              <div class="slds-text-body_small slds-text-color_weak">
                                📞 {call.phone} • 📧 {call.email}
                              </div>
                            </div>
                          </div>
                        </div>

                        <!-- Call Timing -->
                        <div class="slds-col slds-size_3-of-12">
                          <div class="slds-text-align_right">
                            <div class="slds-text-body_small slds-m-bottom_x-small">
                              <strong>{call.scheduledDate}</strong>
                            </div>
                            <div class="slds-text-body_small slds-text-color_weak">
                              {call.scheduledTime}
                            </div>
                            <template if:true={call.daysOverdue}>
                              <lightning-badge label={call.overdueLabel} variant="error" class="slds-m-top_x-small"></lightning-badge>
                            </template>
                          </div>
                        </div>

                        <!-- Quick Complete Button -->
                        <div class="slds-col slds-size_1-of-12 slds-text-align_center">
                          <lightning-button-icon 
                            icon-name="utility:check" 
                            variant="brand" 
                            alternative-text="Complete Call"
                            title="Complete Call"
                            onclick={selectCallForCompletion}
                            data-call-id={call.id}>
                          </lightning-button-icon>
                        </div>
                      </div>
                    </lightning-card>
                  </div>
                </template>
              </div>
            </template>
          </template>
        </div>
        <footer class="slds-modal__footer">
          <lightning-button variant="neutral" label="Close" onclick={closeCallManagementModal}></lightning-button>
          <lightning-button 
            variant="brand" 
            label="Bulk Actions" 
            icon-name="utility:settings"
            onclick={showBulkActions}
            disabled={isLoadingCalls}>
          </lightning-button>
        </footer>
      </div>
    </section>
    <div class="slds-backdrop slds-backdrop_open"></div>
  </template>

  <!-- Call Completion Modal -->
  <template if:true={showCallCompletionModal}>
    <section role="dialog" tabindex="-1" class="slds-modal slds-fade-in-open slds-modal_small" aria-labelledby="completion-modal-heading">
      <div class="slds-modal__container call-completion-modal-container">
        <header class="slds-modal__header slds-p-vertical_small slds-p-horizontal_medium">
          <button class="slds-button slds-button_icon slds-modal__close slds-button_icon-inverse" title="Close" onclick={closeCallCompletionModal}>
            <lightning-icon icon-name="utility:close" alternative-text="close" size="small"></lightning-icon>
          </button>
          <h2 id="completion-modal-heading" class="slds-text-heading_small slds-hyphenate">Complete Call</h2>
        </header>
        <div class="slds-modal__content" id="completion-modal-content" style="padding: 12px 16px;">
          
          <!-- Compact Call Summary -->
          <template if:true={selectedCall}>
            <div class="compact-call-summary" 
                 style="background: #f0fff4; border-left: 3px solid #4bca81; padding: 8px 12px; margin-bottom: 12px; border-radius: 4px;">
              <h3 class="slds-text-body_regular" style="color: #2e844a; margin: 0 0 2px 0; font-weight: 600;">
                📞 {selectedCall.candidateName}
              </h3>
              <p class="slds-text-body_small slds-text-color_weak" style="margin: 0; font-size: 0.75rem;">
                {selectedCall.subject} • {selectedCall.formattedDate} {selectedCall.formattedTime}
              </p>
            </div>
          </template>

          <!-- Compact Completion Form -->
          <div class="compact-completion-form">
            <!-- Call Outcome (Required) -->
            <div class="slds-form-element" style="margin-bottom: 10px;">
              <label class="slds-form-element__label slds-text-body_small" style="margin-bottom: 4px; font-weight: 600;">
                <abbr class="slds-required" title="required">*</abbr> Call Outcome
              </label>
              <div class="slds-form-element__control">
                <lightning-radio-group 
                  name="callOutcome"
                  options={callOutcomeOptions}
                  value={callOutcome}
                  onchange={handleCallOutcomeChange}
                  type="button">
                </lightning-radio-group>
              </div>
            </div>

            <!-- Quick Notes -->
            <div class="slds-form-element" style="margin-bottom: 10px;">
              <label class="slds-form-element__label slds-text-body_small" style="margin-bottom: 4px; font-weight: 600;">
                📝 Call Notes (Optional)
              </label>
              <div class="slds-form-element__control">
                <lightning-textarea 
                  name="callNotes"
                  value={callNotes}
                  onchange={handleCallNotesChange}
                  placeholder="Brief notes about the call..."
                  rows="2"
                  variant="standard">
                </lightning-textarea>
              </div>
            </div>


          </div>
        </div>
        <footer class="slds-modal__footer" style="padding: 8px 16px;">
          <lightning-button variant="neutral" label="Cancel" onclick={closeCallCompletionModal}></lightning-button>
          <lightning-button 
            variant="brand-outline" 
            label="Create Follow Up Call"
            onclick={openFollowUpCallModal}
            icon-name="utility:add_contact">
          </lightning-button>
          <lightning-button 
            variant="brand" 
            label="Complete Call" 
            onclick={submitCallCompletion}
            disabled={isCallCompletionDisabled}
            icon-name="utility:check">
          </lightning-button>
        </footer>
      </div>
    </section>
    <div class="slds-backdrop slds-backdrop_open"></div>
  </template>

  <!-- Schedule Call Modal -->
  <template if:true={showScheduleCallModal}>
    <section role="dialog" tabindex="-1" class="slds-modal slds-fade-in-open slds-modal_medium" aria-labelledby="modal-heading-01" aria-modal="true" aria-describedby="modal-content-id-1">
      <div class="slds-modal__container">
        <header class="slds-modal__header">
          <button class="slds-button slds-button_icon slds-modal__close slds-button_icon-inverse" title="Close" onclick={closeScheduleCallModal}>
            <lightning-icon icon-name="utility:close" alternative-text="close" size="small"></lightning-icon>
            <span class="slds-assistive-text">Close</span>
          </button>
          <h2 id="modal-heading-01" class="slds-modal__title slds-hyphenate">
            <lightning-icon icon-name="utility:phone_portrait" size="small" class="slds-m-right_x-small"></lightning-icon>
            Schedule New Call
          </h2>
        </header>
        <div class="slds-modal__content ultra-compact-modal" id="modal-content-id-1">
          <div class="ultra-compact-form">
            
            <!-- Call Details Section -->
            <div class="form-section">
              <div class="section-header">📞 Call Details</div>
                  
              <!-- Subject -->
              <div class="compact-field">
                <label class="compact-label" for="call-subject">
                  <abbr class="slds-required" title="required">*</abbr>
                  Call Subject
                </label>
                <lightning-input
                  id="call-subject"
                  value={scheduleCallSubject}
                  onchange={handleScheduleCallSubjectChange}
                  placeholder="Enter call subject (e.g., Initial Screening Call)"
                  required>
                </lightning-input>
              </div>

              <!-- Contact Lookup -->
              <div class="compact-field">
                <label class="compact-label" for="call-contact">
                  <abbr class="slds-required" title="required">*</abbr>
                  Contact
                </label>
                <div class="contact-lookup-container">
                  <lightning-input
                    id="call-contact"
                    value={scheduleCallContactName}
                    onchange={handleScheduleCallContactChange}
                    onfocus={handleContactFocus}
                    onblur={handleContactBlur}
                    placeholder="Start typing to search contacts..."
                    required>
                  </lightning-input>
                  <template if:true={showContactOptions}>
                    <div class="contact-dropdown slds-dropdown slds-dropdown_fluid slds-dropdown_length-5">
                      <ul class="slds-dropdown__list" role="listbox">
                        <template if:true={isSearchingContacts}>
                          <li class="contact-dropdown-item" role="option">
                            <div class="contact-option">
                              <div class="contact-name">Searching contacts...</div>
                            </div>
                          </li>
                        </template>
                        <template if:false={isSearchingContacts}>
                          <template for:each={contactOptions} for:item="contact">
                            <li key={contact.Id} class="contact-dropdown-item" role="option" onclick={handleContactSelect} data-contact-id={contact.Id}>
                              <div class="contact-option" data-contact-id={contact.Id}>
                                <div class="contact-name" data-contact-id={contact.Id}>{contact.Name}</div>
                                <template if:true={contact.Email}>
                                  <div class="contact-email" data-contact-id={contact.Id}>{contact.Email}</div>
                                </template>
                                <template if:true={contact.Account}>
                                  <div class="contact-company" data-contact-id={contact.Id}>Company: {contact.Account}</div>
                                </template>
                              </div>
                            </li>
                          </template>
                          <template if:true={noContactsFound}>
                            <li class="contact-dropdown-item" role="option">
                              <div class="contact-option">
                                <div class="contact-name">No contacts found</div>
                              </div>
                            </li>
                          </template>
                        </template>
                      </ul>
                    </div>
                  </template>
                </div>
              </div>
            </div>

            <!-- Schedule Information -->
            <div class="form-section">
              <div class="section-header">📅 Schedule Information</div>
              <!-- Call Date -->
              <div class="compact-field">
                <label class="compact-label" for="call-date">
                  <abbr class="slds-required" title="required">*</abbr>
                  Call Date
                </label>
                <lightning-input
                  type="date"
                  id="call-date"
                  value={scheduleCallDate}
                  onchange={handleScheduleCallDateChange}
                  min={todayDate}
                  required>
                </lightning-input>
              </div>

              <!-- Priority and Status Row -->
              <div class="compact-row">
                <div class="compact-field-half">
                  <label class="compact-label" for="call-priority">Priority</label>
                  <lightning-combobox
                    id="call-priority"
                    value={scheduleCallPriority}
                    onchange={handleScheduleCallPriorityChange}
                    options={callPriorityOptions}
                    placeholder="Select priority level">
                  </lightning-combobox>
                </div>
                <div class="compact-field-half">
                  <label class="compact-label" for="call-status">Status</label>
                  <lightning-combobox
                    id="call-status"
                    value={scheduleCallStatus}
                    onchange={handleScheduleCallStatusChange}
                    options={callStatusOptions}
                    placeholder="Select call status">
                  </lightning-combobox>
                </div>
              </div>
              <!-- Call Notes/Agenda -->
              <div class="compact-field">
                <label class="compact-label" for="call-description">
                  Call Notes/Agenda
                </label>
                <lightning-textarea
                  id="call-description"
                  value={scheduleCallDescription}
                  onchange={handleScheduleCallDescriptionChange}
                  placeholder="Enter call agenda, topics to discuss, or any preparation notes..."
                  max-length="32000"
                  rows="2">
                </lightning-textarea>
              </div>
            </div>

          </div>
        </div>
        <footer class="slds-modal__footer">
          <lightning-button 
            variant="neutral" 
            label="Cancel" 
            onclick={closeScheduleCallModal}>
          </lightning-button>
          <lightning-button 
            variant="brand" 
            label="Schedule Call" 
            onclick={submitScheduleCall}
            disabled={isScheduleCallDisabled}
            icon-name="utility:phone_portrait">
          </lightning-button>
        </footer>
      </div>
    </section>
    <div class="slds-backdrop slds-backdrop_open"></div>
  </template>

  <!-- Active Candidates Modal -->
  <template if:true={showCandidateModal}>
    <section role="dialog" tabindex="-1" class="slds-modal slds-fade-in-open slds-modal_medium" aria-labelledby="candidate-modal-heading">
      <div class="slds-modal__container" style="max-height: 80vh;">
        <header class="slds-modal__header slds-p-vertical_small slds-p-horizontal_medium">
          <button class="slds-button slds-button_icon slds-modal__close slds-button_icon-inverse" title="Close" onclick={closeCandidateModal}>
            <lightning-icon icon-name="utility:close" alternative-text="close" size="small"></lightning-icon>
          </button>
          <h2 id="active-candidate-modal-heading" class="slds-modal__title slds-hyphenate slds-text-heading_small">
            <lightning-icon icon-name="utility:people" size="small" class="slds-m-right_x-small"></lightning-icon>
            {candidateModalTitle}
          </h2>
        </header>
        <div class="slds-modal__content" id="active-candidates-modal-content" style="max-height: 60vh; overflow-y: auto; padding: 1rem;">
          
          <template if:true={isLoadingCandidates}>
            <div class="slds-text-align_center slds-p-around_large">
              <lightning-spinner alternative-text="Loading candidates..." size="medium"></lightning-spinner>
              <p class="slds-text-body_regular slds-m-top_small">Loading active candidates...</p>
            </div>
          </template>

          <template if:false={isLoadingCandidates}>
            <template if:true={candidateModalData}>
              <template if:true={candidateModalData.length}>
                
                <!-- Candidates List -->
                <div class="candidates-list-container">
                  <div class="slds-text-body_small slds-text-color_weak slds-m-bottom_small">
                    Showing {candidateModalData.length} active candidates
                  </div>
                  
                  <template for:each={candidateModalData} for:item="candidate">
                    <div key={candidate.id} class="candidate-list-item slds-box slds-theme_shade" 
                         onclick={handleCandidateClick} data-candidate-id={candidate.id} 
                         title="Click to view candidate details">
                      <div class="slds-grid slds-grid_align-spread slds-grid_vertical-align-start" style="gap: 12px;">
                        <div class="slds-col slds-size_5-of-12">
                          <div style="margin-bottom: 4px;">
                            <strong style="font-size: 16px; color: #181818;">{candidate.name}</strong>
                          </div>
                          <div style="font-size: 14px; color: #666; line-height: 1.3;">
                            {candidate.position}
                          </div>
                          <div style="font-size: 13px; color: #888; margin-top: 2px;">
                            Owner: {candidate.ownerName}
                          </div>
                        </div>
                        <div class="slds-col slds-size_5-of-12">
                          <template if:true={candidate.email}>
                            <div style="margin-bottom: 4px;">
                              📧 <a href={candidate.emailLink} 
                                    onclick={handleEmailClick} 
                                    data-candidate-id={candidate.id}
                                    title={candidate.email}
                                    style="text-decoration: underline; color: #0176d3;">{candidate.email}</a>
                            </div>
                          </template>
                          <template if:true={candidate.phone}>
                            <div>
                              📞 <a href={candidate.phoneLink} 
                                    onclick={handlePhoneClick}
                                    data-candidate-id={candidate.id}
                                    style="text-decoration: underline; color: #0176d3;">{candidate.phone}</a>
                            </div>
                          </template>
                        </div>
                        <div class="slds-col slds-size_2-of-12 slds-text-align_right">
                          <div class="slds-badge slds-badge_success" style="font-size: 12px; padding: 4px 8px;">
                            Active
                          </div>
                        </div>
                      </div>
                    </div>
                  </template>
                </div>

              </template>
              <template if:false={candidateModalData.length}>
                <div class="slds-text-align_center slds-p-around_large">
                  <lightning-icon icon-name="utility:info" size="large" class="slds-m-bottom_medium"></lightning-icon>
                  <h3 class="slds-text-heading_small slds-m-bottom_small">No Active Candidates Found</h3>
                  <p class="slds-text-body_regular slds-text-color_weak">
                    There are currently no candidates with "Active/In Process" status.
                  </p>
                </div>
              </template>
            </template>
          </template>

        </div>
        <footer class="slds-modal__footer slds-p-vertical_small slds-p-horizontal_medium">
          <lightning-button variant="neutral" label="Close" onclick={closeCandidateModal}></lightning-button>
          <lightning-button variant="brand" label="Add New Candidate" disabled title="Coming Soon"></lightning-button>
        </footer>
      </div>
    </section>
    <div class="slds-backdrop slds-backdrop_open"></div>
  </template>

  <!-- Candidate Detail Modal - Editable & Scrollable -->
  <template if:true={showCandidateDetailModal}>
    <section role="dialog" tabindex="-1" class="slds-modal slds-fade-in-open slds-modal_medium" aria-labelledby="candidate-detail-modal-heading">
      <div class="slds-modal__container" style="max-height: 80vh;">
        <header class="slds-modal__header">
          <button class="slds-button slds-button_icon slds-modal__close slds-button_icon-inverse" title="Close" onclick={closeCandidateDetailModal}>
            <lightning-icon icon-name="utility:close" alternative-text="close" size="small"></lightning-icon>
          </button>
          <h2 id="candidate-detail-modal-heading" class="slds-text-heading_medium slds-hyphenate">
            Edit Candidate: {candidateEditName}
          </h2>
        </header>
        <div class="slds-modal__content slds-p-around_medium" style="overflow-y: auto; max-height: 60vh;">

            <!-- Editable Form Fields -->
            <form class="slds-form slds-form_stacked">
              
              <!-- Basic Information -->
              <div class="slds-form-element slds-m-bottom_small">
                <label class="slds-form-element__label" for="candidate-name">
                  <abbr class="slds-required" title="required">* </abbr>Candidate Name
                </label>
                <div class="slds-form-element__control">
                  <lightning-input 
                    id="candidate-name"
                    value={candidateEditName}
                    onchange={handleCandidateNameChange}
                    required>
                  </lightning-input>
                </div>
              </div>

              <!-- Contact Information Section -->
              <fieldset class="slds-form-element slds-m-bottom_small">
                <legend class="slds-form-element__legend slds-text-heading_small">Contact Information</legend>
                
                <div class="slds-form-element__control">
                  <div class="slds-grid slds-gutters slds-wrap">
                    
                    <div class="slds-col slds-size_1-of-2">
                      <div class="slds-form-element">
                        <label class="slds-form-element__label" for="candidate-email">Email</label>
                        <div class="slds-form-element__control">
                          <lightning-input 
                            id="candidate-email"
                            type="email"
                            value={candidateEditEmail}
                            onchange={handleCandidateEmailChange}>
                          </lightning-input>
                        </div>
                      </div>
                    </div>
                    
                    <div class="slds-col slds-size_1-of-2">
                      <div class="slds-form-element">
                        <label class="slds-form-element__label" for="candidate-phone">Phone</label>
                        <div class="slds-form-element__control">
                          <lightning-input 
                            id="candidate-phone"
                            type="tel"
                            value={candidateEditPhone}
                            onchange={handleCandidatePhoneChange}>
                          </lightning-input>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </fieldset>

              <!-- Professional Information -->
              <fieldset class="slds-form-element slds-m-bottom_small">
                <legend class="slds-form-element__legend slds-text-heading_small">Professional Details</legend>
                
                <div class="slds-form-element__control">
                  <div class="slds-grid slds-gutters slds-wrap">
                    
                    <div class="slds-col slds-size_1-of-2">
                      <div class="slds-form-element">
                        <label class="slds-form-element__label" for="candidate-position">Position</label>
                        <div class="slds-form-element__control">
                          <lightning-combobox
                            id="candidate-position"
                            value={candidateEditPosition}
                            options={positionOptions}
                            onchange={handleCandidatePositionChange}>
                          </lightning-combobox>
                        </div>
                      </div>
                    </div>
                    
                    <div class="slds-col slds-size_1-of-2">
                      <div class="slds-form-element">
                        <label class="slds-form-element__label" for="candidate-status">Status</label>
                        <div class="slds-form-element__control">
                          <lightning-combobox
                            id="candidate-status"
                            value={candidateEditStatus}
                            options={statusOptions}
                            onchange={handleCandidateStatusChange}>
                          </lightning-combobox>
                        </div>
                      </div>
                    </div>
                    
                    <div class="slds-col slds-size_1-of-2">
                      <div class="slds-form-element">
                        <label class="slds-form-element__label" for="office-location">Office Location</label>
                        <div class="slds-form-element__control">
                          <lightning-combobox
                            id="office-location"
                            value={candidateEditOfficeLocation}
                            options={officeLocationOptions}
                            onchange={handleOfficeLocationChange}>
                          </lightning-combobox>
                        </div>
                      </div>
                    </div>
                    
                    <div class="slds-col slds-size_1-of-2">
                      <div class="slds-form-element">
                        <label class="slds-form-element__label" for="sales-manager">Sales Manager</label>
                        <div class="slds-form-element__control">
                          <lightning-combobox
                            id="sales-manager"
                            value={candidateEditSalesManager}
                            options={salesManagerOptions}
                            onchange={handleSalesManagerChange}>
                          </lightning-combobox>
                        </div>
                      </div>
                    </div>
                    
                    <div class="slds-col slds-size_1-of-2">
                      <div class="slds-form-element">
                        <label class="slds-form-element__label" for="recruiter">Recruiter</label>
                        <div class="slds-form-element__control">
                          <lightning-combobox
                            id="recruiter"
                            value={candidateEditRecruiter}
                            options={recruiterOptions}
                            onchange={handleRecruiterChange}>
                          </lightning-combobox>
                        </div>
                      </div>
                    </div>
                    
                    <div class="slds-col slds-size_1-of-2">
                      <div class="slds-form-element">
                        <label class="slds-form-element__label" for="next-meeting">Next Meeting</label>
                        <div class="slds-form-element__control">
                          <div class="slds-form-element__static">{candidateEditNextMeeting}</div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </fieldset>

              <!-- Notes and Summary -->
              <fieldset class="slds-form-element slds-m-bottom_small">
                <legend class="slds-form-element__legend slds-text-heading_small">Notes & Summary</legend>
                
                <div class="slds-form-element__control">
                  <div class="slds-grid slds-gutters slds-wrap">
                    
                    <div class="slds-col slds-size_1-of-1">
                      <div class="slds-form-element">
                        <label class="slds-form-element__label" for="candidate-summary">Candidate Summary</label>
                        <div class="slds-form-element__control">
                          <lightning-textarea
                            id="candidate-summary"
                            value={candidateEditSummary}
                            onchange={handleCandidateSummaryChange}>
                          </lightning-textarea>
                        </div>
                      </div>
                    </div>
                    
                    <div class="slds-col slds-size_1-of-1">
                      <div class="slds-form-element">
                        <label class="slds-form-element__label" for="all-notes">All Notes</label>
                        <div class="slds-form-element__control">
                          <lightning-textarea
                            id="all-notes"
                            value={candidateEditAllNotes}
                            onchange={handleAllNotesChange}>
                          </lightning-textarea>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </fieldset>

              <!-- Timeline Information -->
              <fieldset class="slds-form-element">
                <legend class="slds-form-element__legend slds-text-heading_small">Timeline</legend>
                
                <div class="slds-form-element__control">
                  <div class="slds-grid slds-gutters">
                    
                    <div class="slds-col slds-size_1-of-2">
                      <div class="slds-form-element">
                        <label class="slds-form-element__label">Created Date</label>
                        <div class="slds-form-element__control">
                          <div class="slds-form-element__static">{candidateEditCreatedDate}</div>
                        </div>
                      </div>
                    </div>
                    
                    <div class="slds-col slds-size_1-of-2">
                      <div class="slds-form-element">
                        <label class="slds-form-element__label">Last Modified</label>
                        <div class="slds-form-element__control">
                          <div class="slds-form-element__static">{candidateEditLastModified}</div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </fieldset>
            </form>

        </div>
        <footer class="slds-modal__footer">
          <lightning-button 
            variant="neutral" 
            label="Cancel" 
            onclick={closeCandidateDetailModal}>
          </lightning-button>
          <lightning-button 
            variant="brand" 
            label="Save Changes" 
            onclick={saveCandidateChanges}
            class="slds-m-left_x-small">
          </lightning-button>
        </footer>
      </div>
    </section>
    <div class="slds-backdrop slds-backdrop_open"></div>
  </template>
</template>

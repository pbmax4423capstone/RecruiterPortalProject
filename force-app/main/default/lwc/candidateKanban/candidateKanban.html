<template>
    <lightning-card title="Candidate Pipeline" icon-name="standard:opportunity">
        <div slot="actions">
            <!-- Sales Manager Filter Buttons (Only visible for Directors/Admins) -->
            <template if:true={showSalesManagerDropdown}>
                <div class="slds-button-group sales-manager-filter-group" role="group">
                    <template for:each={salesManagerFilters} for:item="filter">
                        <lightning-button
                            key={filter.value}
                            label={filter.label}
                            variant={filter.variant}
                            onclick={handleSalesManagerFilterChange}
                            data-manager={filter.value}
                            class="sales-manager-filter-button"
                            title={filter.title}>
                        </lightning-button>
                    </template>
                </div>
            </template>
            <!-- Current Selection Label (for non-Directors) -->
            <template if:false={showSalesManagerDropdown}>
                <div class="current-manager-label slds-m-right_small">
                    <lightning-icon icon-name="standard:user" size="x-small" class="slds-m-right_xx-small"></lightning-icon>
                    <span class="slds-text-body_small slds-text-color_weak">
                        Viewing: <strong>{selectedSalesManagerLabel}</strong>
                    </span>
                </div>
            </template>
            <lightning-badge label={totalCandidates} class="slds-m-right_small"></lightning-badge>
        </div>

        <template if:true={isLoading}>
            <div class="slds-is-relative loading-container">
                <lightning-spinner alternative-text="Loading..." size="medium"></lightning-spinner>
            </div>
        </template>

        <template if:true={error}>
            <div class="slds-text-color_error slds-p-around_medium">
                {error}
            </div>
        </template>

        <template if:false={isLoading}>
            <div class={containerClass}>
                <template for:each={stagesWithCandidates} for:item="stage">
                    <div key={stage.value} 
                         class="kanban-column"
                         data-stage={stage.value}
                         ondragover={handleDragOver}
                         ondragleave={handleDragLeave}
                         ondrop={handleDrop}>
                        
                        <!-- Column Header -->
                        <div class="column-header">
                            <span class="column-title">{stage.label}</span>
                            <span class="column-count">{stage.count}</span>
                        </div>

                        <!-- Cards Container -->
                        <div class="cards-container">
                            <template for:each={stage.candidates} for:item="candidate">
                                <div key={candidate.id} 
                                     class={candidate.cardClass}
                                     data-id={candidate.id}
                                     data-stage={stage.value}
                                     draggable="true"
                                     ondragstart={handleDragStart}
                                     ondragend={handleDragEnd}
                                     onclick={handleCardClick}>
                                    
                                    <!-- Card Header -->
                                    <div class="card-header">
                                        <div class="avatar">
                                            <span class="initials">{candidate.initials}</span>
                                        </div>
                                        <div class="candidate-info">
                                            <div class="candidate-name">{candidate.name}</div>
                                            <div class="candidate-location">{candidate.location}</div>
                                        </div>
                                    </div>

                                    <!-- Quick Actions -->
                                    <div class="quick-actions">
                                        <template if:true={candidate.email}>
                                            <button class="action-btn" 
                                                    data-email={candidate.email}
                                                    onclick={handleEmailClick}
                                                    title="Send Email">
                                                <lightning-icon icon-name="utility:email" size="xx-small"></lightning-icon>
                                            </button>
                                        </template>
                                        <template if:true={candidate.phone}>
                                            <button class="action-btn"
                                                    data-phone={candidate.phone}
                                                    onclick={handlePhoneClick}
                                                    title="Call">
                                                <lightning-icon icon-name="utility:call" size="xx-small"></lightning-icon>
                                            </button>
                                        </template>
                                        <button class="action-btn" title="View Record">
                                            <lightning-icon icon-name="utility:preview" size="xx-small"></lightning-icon>
                                        </button>
                                    </div>

                                    <!-- Card Details -->
                                    <div class="card-details">
                                        <div class="detail-row">
                                            <lightning-icon icon-name="utility:user" size="xx-small" class="detail-icon"></lightning-icon>
                                            <span class="detail-text">{candidate.recruiterName}</span>
                                        </div>
                                        <!-- Sales Manager -->
                                        <template if:true={candidate.salesManager}>
                                            <div class="detail-row">
                                                <lightning-icon icon-name="utility:groups" size="xx-small" class="detail-icon"></lightning-icon>
                                                <span class="detail-text">SM: {candidate.salesManager}</span>
                                            </div>
                                        </template>
                                        <!-- Interview Stage -->
                                        <template if:true={candidate.interviewStage}>
                                            <div class="detail-row">
                                                <lightning-icon icon-name="utility:event" size="xx-small" class="detail-icon"></lightning-icon>
                                                <span class="detail-text interview-badge">{candidate.interviewStage}</span>
                                                <template if:true={candidate.interviewStatus}>
                                                    <span class="interview-status">({candidate.interviewStatus})</span>
                                                </template>
                                            </div>
                                        </template>
                                        <!-- ALC Contracting Stage -->
                                        <template if:true={candidate.contractingStage}>
                                            <div class="detail-row contracting-row">
                                                <lightning-icon icon-name="utility:contract" size="xx-small" class="detail-icon contracting-icon"></lightning-icon>
                                                <span class="detail-text contracting-stage-text">{candidate.contractingStage}</span>
                                            </div>
                                        </template>
                                    </div>

                                    <!-- Latest Note -->
                                    <template if:true={candidate.latestNote}>
                                        <div class="card-note">
                                            <lightning-icon icon-name="utility:note" size="xx-small" class="note-icon"></lightning-icon>
                                            <span class="note-text">{candidate.latestNote}</span>
                                        </div>
                                    </template>

                                    <!-- Card Footer -->
                                    <div class="card-footer">
                                        <span class="time-ago">
                                            <lightning-icon icon-name="utility:clock" size="xx-small" class="time-icon"></lightning-icon>
                                            {candidate.timeAgo}
                                        </span>
                                    </div>
                                </div>
                            </template>

                            <!-- Empty State -->
                            <template if:false={stage.hasCandidates}>
                                <div class="empty-column">
                                    <lightning-icon icon-name="utility:add" size="small"></lightning-icon>
                                    <span>No candidates</span>
                                </div>
                            </template>
                        </div>
                    </div>
                </template>
            </div>
        </template>
    </lightning-card>
</template>